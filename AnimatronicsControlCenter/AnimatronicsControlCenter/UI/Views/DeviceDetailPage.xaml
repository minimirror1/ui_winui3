<Page
    x:Class="AnimatronicsControlCenter.UI.Views.DeviceDetailPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:AnimatronicsControlCenter.Core.Models"
    mc:Ignorable="d">

    <Grid Padding="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <StackPanel Orientation="Horizontal" Spacing="20">
            <TextBlock Text="{x:Bind ViewModel.SelectedDevice.Id, FallbackValue='No Device Selected', Mode=OneWay}" Style="{StaticResource TitleTextBlockStyle}"/>
            <TextBlock Text="{x:Bind ViewModel.SelectedDevice.StatusMessage, FallbackValue='Unknown', Mode=OneWay}" VerticalAlignment="Center"/>
        </StackPanel>

        <Pivot Grid.Row="1">
            <PivotItem Header="Overview">
                <Grid RowSpacing="20">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <!-- Motion Control Panel -->
                    <Grid Grid.Row="0" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="15" CornerRadius="8" RowSpacing="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <!-- Status Area -->
                        <StackPanel Orientation="Horizontal" Spacing="10" HorizontalAlignment="Center">
                             <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionState, Mode=OneWay}" 
                                       Style="{StaticResource SubtitleTextBlockStyle}" 
                                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                        </StackPanel>

                        <!-- Progress Area -->
                        <Grid Grid.Row="1" ColumnSpacing="10">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            
                            <TextBlock Text="{x:Bind ViewModel.FormatTime(ViewModel.SelectedDevice.MotionCurrentTime), Mode=OneWay}" 
                                       VerticalAlignment="Center" Style="{StaticResource CaptionTextBlockStyle}"/>
                                       
                            <Slider Grid.Column="1" 
                                    Value="{x:Bind ViewModel.SelectedDevice.MotionCurrentTime.TotalSeconds, Mode=OneWay}"
                                    Maximum="{x:Bind ViewModel.SelectedDevice.MotionTotalTime.TotalSeconds, Mode=OneWay}"
                                    PointerCaptureLost="MotionSlider_PointerCaptureLost"
                                    VerticalAlignment="Center"/>
                                    
                            <TextBlock Grid.Column="2" 
                                       Text="{x:Bind ViewModel.FormatTime(ViewModel.SelectedDevice.MotionTotalTime), Mode=OneWay}" 
                                       VerticalAlignment="Center" Style="{StaticResource CaptionTextBlockStyle}"/>
                        </Grid>

                        <!-- Control Area -->
                        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="20" HorizontalAlignment="Center">
                             <AppBarButton Icon="Stop" Label="Stop" Command="{x:Bind ViewModel.StopMotionCommand}"/>
                             <AppBarButton Icon="Play" Label="Play" Command="{x:Bind ViewModel.PlayMotionCommand}" Foreground="{ThemeResource SystemControlHighlightAccentBrush}"/>
                             <AppBarButton Icon="Pause" Label="Pause" Command="{x:Bind ViewModel.PauseMotionCommand}"/>
                        </StackPanel>
                    </Grid>

                    <!-- Motion Info Panel -->
                    <StackPanel Grid.Row="1" Orientation="Horizontal" Spacing="20" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Padding="10" CornerRadius="4">
                        <StackPanel>
                            <TextBlock Text="Total Time" Style="{StaticResource CaptionTextBlockStyle}"/>
                            <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionTotalTime, Mode=OneWay}"/>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Data Count" Style="{StaticResource CaptionTextBlockStyle}"/>
                            <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionDataCount, Mode=OneWay}"/>
                        </StackPanel>
                        <StackPanel>
                            <TextBlock Text="Created At" Style="{StaticResource CaptionTextBlockStyle}"/>
                            <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionCreatedAt, Mode=OneWay}"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Motor List -->
                    <ScrollViewer Grid.Row="2">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.SelectedDevice.Motors, Mode=OneWay}">
                            <ItemsControl.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <WrapGrid Orientation="Horizontal" MaximumRowsOrColumns="3" HorizontalAlignment="Stretch"/>
                                </ItemsPanelTemplate>
                            </ItemsControl.ItemsPanel>
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="models:MotorState">
                                    <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" Margin="5" Padding="10" CornerRadius="4" Width="250">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        
                                        <TextBlock Text="{x:Bind DisplayId}" FontWeight="Bold"/>
                                        <TextBlock Grid.Column="1" Text="{x:Bind Type}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                        
                                        <TextBlock Grid.Row="1" Text="{x:Bind Status}" Foreground="{ThemeResource SystemControlErrorTextForegroundBrush}" Margin="0,5,0,0"/>
                                        
                                        <StackPanel Grid.Row="2" Grid.ColumnSpan="2" Margin="0,10,0,0">
                                            <TextBlock Text="Position"/>
                                            <Slider Value="{x:Bind Position, Mode=TwoWay}" Minimum="0" Maximum="180" 
                                                    PointerCaptureLost="Slider_PointerCaptureLost"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </PivotItem>
            
            <PivotItem Header="Files">
                <Grid ColumnSpacing="20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="300"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="0" RowSpacing="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <CommandBar DefaultLabelPosition="Right">
                            <AppBarButton Icon="Refresh" Label="Refresh" Command="{x:Bind ViewModel.RefreshFilesCommand}"/>
                        </CommandBar>
                        <TreeView x:Name="FileTreeView" Grid.Row="1" ItemInvoked="FileTreeView_ItemInvoked" ItemsSource="{x:Bind ViewModel.Files, Mode=OneWay}">
                            <TreeView.ItemTemplate>
                                <DataTemplate x:DataType="models:FileSystemItem">
                                    <TreeViewItem ItemsSource="{x:Bind Children}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon Glyph="{x:Bind Icon}" FontFamily="Segoe MDL2 Assets" FontSize="16"/>
                                            <TextBlock Text="{x:Bind Name}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </TreeViewItem>
                                </DataTemplate>
                            </TreeView.ItemTemplate>
                        </TreeView>
                    </Grid>

                    <Grid Grid.Column="1" RowSpacing="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="{x:Bind ViewModel.SelectedFile.Name, FallbackValue='No File Selected', Mode=OneWay}" Style="{StaticResource SubtitleTextBlockStyle}"/>
                        
                        <TextBox Grid.Row="1" Text="{x:Bind ViewModel.FileContent, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                 AcceptsReturn="True" FontFamily="Consolas" IsSpellCheckEnabled="False"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"/>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right">
                            <Button Content="Verify" Command="{x:Bind ViewModel.VerifyFileCommand}"/>
                            <Button Content="Save to Device" Command="{x:Bind ViewModel.SaveFileCommand}" Style="{StaticResource AccentButtonStyle}"/>
                        </StackPanel>
                    </Grid>
                    
                    <ProgressRing IsActive="{x:Bind ViewModel.IsFileLoading, Mode=OneWay}" Width="50" Height="50" Grid.ColumnSpan="2" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                </Grid>
            </PivotItem>
            
            <PivotItem Header="Terminal">
                <TextBlock Text="Terminal Placeholder"/>
            </PivotItem>
        </Pivot>

        <ContentDialog x:Name="VerificationDialog" Title="Verification Result" PrimaryButtonText="OK" 
                       IsPrimaryButtonEnabled="True" CloseButtonText="Close">
            <StackPanel>
                <TextBlock Text="{x:Bind ViewModel.VerificationResult, Mode=OneWay}"/>
            </StackPanel>
        </ContentDialog>
    </Grid>
</Page>
