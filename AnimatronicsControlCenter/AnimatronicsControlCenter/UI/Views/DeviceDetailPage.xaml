<Page
    x:Class="AnimatronicsControlCenter.UI.Views.DeviceDetailPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:models="using:AnimatronicsControlCenter.Core.Models"
    mc:Ignorable="d">

    <Grid Padding="24">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Device Header -->
        <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="16" Margin="0,0,0,24">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            
            <StackPanel Orientation="Horizontal" Spacing="12">
                <FontIcon Glyph="&#xE966;" FontFamily="Segoe MDL2 Assets" FontSize="24"/>
                <TextBlock Text="{x:Bind ViewModel.SelectedDevice.Id, FallbackValue='Device #0', Mode=OneWay}" 
                           Style="{StaticResource TitleTextBlockStyle}" VerticalAlignment="Center"/>
            </StackPanel>

            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                <TextBlock Text="Status:" Style="{StaticResource BodyStrongTextBlockStyle}" VerticalAlignment="Center"/>
                <Border Background="{ThemeResource CardBackgroundFillColorSecondaryBrush}" CornerRadius="4" Padding="8,4">
                    <TextBlock Text="{x:Bind ViewModel.SelectedDevice.StatusMessage, FallbackValue='Unknown', Mode=OneWay}" 
                               Style="{StaticResource CaptionTextBlockStyle}"/>
                </Border>
            </StackPanel>
        </Grid>

        <Pivot x:Name="MainPivot" Grid.Row="1" SelectionChanged="MainPivot_SelectionChanged">
            <PivotItem Header="Overview" Margin="0,12,0,0">
                <Grid ColumnSpacing="24">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="400" MaxWidth="500"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>
                    
                    <!-- Left Column: Controls & Info -->
                    <StackPanel Spacing="24">
                        <!-- Motion Control Card -->
                        <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20" RowSpacing="16">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>

                            <StackPanel Spacing="4">
                                <TextBlock Text="Motion Control" Style="{StaticResource SubtitleTextBlockStyle}"/>
                                <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionState, Mode=OneWay}" 
                                           Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                            </StackPanel>

                            <!-- Progress -->
                            <Grid Grid.Row="1" RowSpacing="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                
                                <Grid>
                                    <TextBlock Text="{x:Bind ViewModel.FormatTime(ViewModel.SelectedDevice.MotionCurrentTime), Mode=OneWay}" 
                                               HorizontalAlignment="Left" Style="{StaticResource CaptionTextBlockStyle}"/>
                                    <TextBlock Text="{x:Bind ViewModel.FormatTime(ViewModel.SelectedDevice.MotionTotalTime), Mode=OneWay}" 
                                               HorizontalAlignment="Right" Style="{StaticResource CaptionTextBlockStyle}"/>
                                </Grid>

                                <Slider Grid.Row="1" 
                                        Value="{x:Bind ViewModel.SelectedDevice.MotionCurrentTime.TotalSeconds, Mode=OneWay}"
                                        Maximum="{x:Bind ViewModel.SelectedDevice.MotionTotalTime.TotalSeconds, Mode=OneWay}"
                                        PointerCaptureLost="MotionSlider_PointerCaptureLost"/>
                            </Grid>

                            <!-- Controls -->
                            <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="16" HorizontalAlignment="Center">
                                <Button Command="{x:Bind ViewModel.StopMotionCommand}" Padding="12" CornerRadius="20" ToolTipService.ToolTip="Stop">
                                    <FontIcon Glyph="&#xE71A;" FontFamily="Segoe MDL2 Assets"/>
                                </Button>
                                <Button Command="{x:Bind ViewModel.PlayMotionCommand}" Style="{StaticResource AccentButtonStyle}" Padding="16" CornerRadius="30" ToolTipService.ToolTip="Play">
                                    <FontIcon Glyph="&#xE768;" FontFamily="Segoe MDL2 Assets" FontSize="20"/>
                                </Button>
                                <Button Command="{x:Bind ViewModel.PauseMotionCommand}" Padding="12" CornerRadius="20" ToolTipService.ToolTip="Pause">
                                    <FontIcon Glyph="&#xE769;" FontFamily="Segoe MDL2 Assets"/>
                                </Button>
                            </StackPanel>
                        </Grid>

                        <!-- File Info Card -->
                        <Grid Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20" RowSpacing="12">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBlock Text="File Information" Style="{StaticResource SubtitleTextBlockStyle}"/>
                            
                            <Grid Grid.Row="1" ColumnSpacing="16" RowSpacing="16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>

                                <StackPanel>
                                    <TextBlock Text="Total Duration" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                    <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionTotalTime, Mode=OneWay}" Style="{StaticResource BodyTextBlockStyle}"/>
                                </StackPanel>

                                <StackPanel Grid.Column="1">
                                    <TextBlock Text="Data Points" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                    <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionDataCount, Mode=OneWay}" Style="{StaticResource BodyTextBlockStyle}"/>
                                </StackPanel>

                                <StackPanel Grid.Row="1" Grid.ColumnSpan="2">
                                    <TextBlock Text="Created At" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                    <TextBlock Text="{x:Bind ViewModel.SelectedDevice.MotionCreatedAt, Mode=OneWay}" Style="{StaticResource BodyTextBlockStyle}"/>
                                </StackPanel>
                            </Grid>
                        </Grid>
                    </StackPanel>

                    <!-- Right Column: Motors -->
                    <Grid Grid.Column="1" Background="{ThemeResource CardBackgroundFillColorDefaultBrush}" CornerRadius="8" Padding="20">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <Grid Margin="0,0,0,16">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="Motors" Style="{StaticResource SubtitleTextBlockStyle}"/>
                                <Border Background="{ThemeResource SystemControlBackgroundBaseLowBrush}" CornerRadius="10" Padding="8,0" VerticalAlignment="Center">
                                    <TextBlock Text="{x:Bind ViewModel.SelectedDevice.Motors.Count, Mode=OneWay}" Style="{StaticResource CaptionTextBlockStyle}"/>
                                </Border>
                            </StackPanel>

                            <!-- Polling controls -->
                            <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                                <ToggleSwitch Header="Polling" IsOn="{x:Bind ViewModel.IsMotorPollingEnabled, Mode=TwoWay}" />

                                <StackPanel>
                                    <TextBlock Text="Interval (ms)" Style="{StaticResource CaptionTextBlockStyle}" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                    <ComboBox ItemsSource="{x:Bind ViewModel.MotorPollingIntervals}"
                                              SelectedItem="{x:Bind ViewModel.MotorPollingIntervalMs, Mode=TwoWay}"
                                              MinWidth="120"/>
                                </StackPanel>

                                <Button Content="Refresh" Command="{x:Bind ViewModel.RefreshMotorsCommand}" />
                            </StackPanel>
                        </Grid>

                        <GridView Grid.Row="1" ItemsSource="{x:Bind ViewModel.SelectedDevice.Motors, Mode=OneWay}" SelectionMode="None">
                            <GridView.ItemTemplate>
                                <DataTemplate x:DataType="models:MotorState">
                                    <Grid Background="{ThemeResource LayerFillColorDefaultBrush}" CornerRadius="4" Padding="12" Width="200" BorderThickness="1" BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}">
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <StackPanel Orientation="Horizontal" Spacing="4">
                                                <FontIcon Glyph="&#xE966;" FontFamily="Segoe MDL2 Assets" FontSize="12" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                                <TextBlock Text="{x:Bind DisplayId}" FontWeight="SemiBold"/>
                                            </StackPanel>
                                            <TextBlock Grid.Column="1" Text="{x:Bind Status}" FontSize="12" 
                                                       Foreground="{ThemeResource SystemControlErrorTextForegroundBrush}"/>
                                        </Grid>

                                        <TextBlock Grid.Row="1" Text="{x:Bind Type}" FontSize="12" 
                                                   Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}" Margin="0,4,0,8"/>

                                        <StackPanel Grid.Row="2">
                                            <Grid Margin="0,0,0,4">
                                                <TextBlock Text="Position" FontSize="10" Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"/>
                                                <TextBlock Text="{x:Bind Position, Mode=OneWay}" FontSize="10" HorizontalAlignment="Right"/>
                                            </Grid>
                                            <Slider Value="{x:Bind Position, Mode=TwoWay}" Minimum="0" Maximum="180" 
                                                    PointerCaptureLost="Slider_PointerCaptureLost"
                                                    Height="32"/>
                                        </StackPanel>
                                    </Grid>
                                </DataTemplate>
                            </GridView.ItemTemplate>
                            <GridView.ItemsPanel>
                                <ItemsPanelTemplate>
                                    <ItemsWrapGrid Orientation="Horizontal" MaximumRowsOrColumns="4"/>
                                </ItemsPanelTemplate>
                            </GridView.ItemsPanel>
                        </GridView>
                    </Grid>
                </Grid>
            </PivotItem>
            
            <PivotItem Header="Files">
                <Grid ColumnSpacing="20">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="300"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <Grid Grid.Column="0" RowSpacing="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>
                        <CommandBar DefaultLabelPosition="Right">
                            <AppBarButton Icon="Refresh" Label="Refresh" Command="{x:Bind ViewModel.RefreshFilesCommand}"/>
                        </CommandBar>
                        <TreeView x:Name="FileTreeView" Grid.Row="1" ItemInvoked="FileTreeView_ItemInvoked" ItemsSource="{x:Bind ViewModel.Files, Mode=OneWay}">
                            <TreeView.ItemTemplate>
                                <DataTemplate x:DataType="models:FileSystemItem">
                                    <TreeViewItem ItemsSource="{x:Bind Children}">
                                        <StackPanel Orientation="Horizontal" Spacing="8">
                                            <FontIcon Glyph="{x:Bind Icon}" FontFamily="Segoe MDL2 Assets" FontSize="16"/>
                                            <TextBlock Text="{x:Bind Name}" VerticalAlignment="Center"/>
                                        </StackPanel>
                                    </TreeViewItem>
                                </DataTemplate>
                            </TreeView.ItemTemplate>
                        </TreeView>
                    </Grid>

                    <Grid Grid.Column="1" RowSpacing="10">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="{x:Bind ViewModel.SelectedFile.Name, FallbackValue='No File Selected', Mode=OneWay}" Style="{StaticResource SubtitleTextBlockStyle}"/>
                        
                        <TextBox Grid.Row="1" Text="{x:Bind ViewModel.FileContent, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" 
                                 AcceptsReturn="True" FontFamily="Consolas" IsSpellCheckEnabled="False"
                                 ScrollViewer.VerticalScrollBarVisibility="Auto" ScrollViewer.HorizontalScrollBarVisibility="Auto"/>

                        <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="10" HorizontalAlignment="Right">
                            <Button Content="Verify" Command="{x:Bind ViewModel.VerifyFileCommand}"/>
                            <Button Content="Save to Device" Command="{x:Bind ViewModel.SaveFileCommand}" Style="{StaticResource AccentButtonStyle}"/>
                        </StackPanel>
                    </Grid>
                    
                    <ProgressRing IsActive="{x:Bind ViewModel.IsFileLoading, Mode=OneWay}" Width="50" Height="50" Grid.ColumnSpan="2" VerticalAlignment="Center" HorizontalAlignment="Center"/>
                </Grid>
            </PivotItem>
            
            <PivotItem Header="Terminal">
                <TextBlock Text="Terminal Placeholder"/>
            </PivotItem>
        </Pivot>

        <ContentDialog x:Name="VerificationDialog" Title="Verification Result" PrimaryButtonText="OK" 
                       IsPrimaryButtonEnabled="True" CloseButtonText="Close">
            <StackPanel>
                <TextBlock Text="{x:Bind ViewModel.VerificationResult, Mode=OneWay}"/>
            </StackPanel>
        </ContentDialog>
    </Grid>
</Page>

